# 主机失效预测

如何预测一台远端主机将要失效？
失效主要是指系统的应用服务无法访问或无法正常访问，这里引申为功能的不可用以及性能的不可达。功能的不可用是指应用服务无法访问，性能的不可达是指应用服务的性能无法达到标准性能。

一台处于局域网中的主机监控指标无外乎三个方面：硬件、软件服务、网络。下面分别从这三个方面讨论哪些指标适合作为预测算法的参数，并说明为什么。

## 硬件指标

硬件主要包含主板，CPU，硬盘，内存，风扇等组件。考虑到主板、硬盘、内存发生一般性故障后系统直接蓝屏或死机，故不纳入预测的参考指标。

内存容量，如果跑满会导致系统响应变慢，影响效率。然而需要区分windows主机和linux主机。windows主机的内存容量占比以及内存的增长速率将会是预测性能失效的指标。而linux由于操作系统内存管理的机制，需要看最近5分钟负载指数。

硬盘容量，如果是Windows有单独的C盘和数据盘，一般不会往C盘写数据，不会因为数据增长而导致系统不可用；对于Linux系统，如果数据增长到挂载盘的最大值时，会使得系统服务无法读写文件而导致不可用，所以对于Linux系统，硬盘容量以及数据增长速率会是系统可用性的一个指标。

CPU温度高于120度说明风扇和散热有问题，长时间保持120度以上的温度容易造成主板烧毁等毁灭性故障。

CPU使用率每个核都达到高负载会影响应用服务的性能。

## 软件服务

进程数: 高，zombie进程多导致性能丧失或卡顿。

应用服务: 服务挂掉导致不可用；超过最大连接数导致性能低下；应用服务组件挂掉导致部分功能不可用。

数据库服务: 数据库连接数过多导致数据库不可用；

磁盘IO: 某些进程IO负载高，导致其他进程读写受影响。（这种情况视高负载持续时长来定）

## 网络
ping: 如果开启的情况下可判断主机是否可访问，通过延迟指数和丢包率可以判断主机网络可用情况

wget: 在已知应用服务端口的情况下通过wget命令判断服务是否已挂掉。

流量负载高:流量负载高，在带宽固定的情况下容易造成网络服务的不可用或性能问题。

## 主机失效算法
综上，罗列出算法相关指标：

1. CPU平均温度高于阀值T(120度),持续一段时间阀值t(比如60分钟)，标记为系统效率不高。
2. CPU最低单核使用率Cu(99%),持续一段时间阀值Ct(比如60分钟)，标记为系统效率不高。
3. Windows内存，当前使用率Mcu(60%)，增长速率Mv(20M/s),持续稳定保持增长一个时间长度为Mt(比如24小时)的增长，则可估算预计内存满值时间MT，满值后服务或系统不可用。
4. Linux内存，查看5分钟负载持续一段时间Mt(比如60分钟)内的变化趋势，如果Mt时间内5分钟负载值持续大于5的话，说明系统性能受到影响，标记为系统效率不高。
5. 数据盘的硬盘容量，当前使用率Hcu(60%)，增长速率Hv(比如10G/天)，持续稳定保持一个时间长度为Ht(10天)的增长，则可估算预计数据盘满值时间HT，满值后标记为服务或系统不可用。
6. 监控应用服务相关进程，若某个进程关闭，则标记为部分不可用。
7. 监控应用服务打开的文件数的增长速率Sv，则可估算打开文件数增到到MAX的时间ST，文件打开数到达MAX则意味着应用服务不可用，失效。
8. 监控数据库服务连接数，连接数已满时标记为服务不可用。
9. 磁盘IO监控，在一个持续的时间IOt(60分钟)内，系统的5分钟负载wa值(cpu等待磁盘写入完成时间)持续高于阀值WAv(某个数值)，则认定为IO负载高且并无降低趋势，标记为系统效率不高。
10. ping服务开启时，ping不通直接标记为服务或系统不可用。
11. ping服务开启时，ping值在一个时间阶段T(60分钟)的延迟高于一个阀值pv(500ms)时，标记为系统效率不高。
12. ping服务开启时，若ping值在一个时间阶段T(60分钟)的延迟高，且频率性丢包(10个里丢4个)，则标记为系统效率不高。
13. 前提http服务，且服务端口已知的情况下，wget请求基础连接，200返回正常，非200或请求超时考虑标记为服务不可用。
14. 在清楚主机网卡带宽及局域网内带宽的情况下，若网络负载情况在持续的时间阶段T(60分钟)内在阀值以上，则标记为系统效率不高。

基于以上几条，总结如下：
1. 系统效率低或负载过高依托指标：CPU平均温度、CPU最低单核使用率超过阀值、5分钟负载值在阀值T时间段内超过5、系统wa值在时间T内持续高过阀值、ping延迟高过阀值、ping丢包率高过阀值、网络负载情况视带宽情况高过阀值。
2. 服务不可用依托指标：Windows内存预测满值、数据磁盘预测满值、应用进程自动停止、打开文件数MAX、数据库连接数MAX、ping不通、wget返回异常code或连接超时。
3. 可预测时间的指标：Windows内存预测满值、数据磁盘预测满值、打开文件数MAX、数据库连接数MAX
4. 所有标记为效率不高的可依托指标不同，记分标定不同权值，以此来设定预计失效时间。
5. 在一定程度上，硬件、网络与应用服务的指标之间具有相关性，在算法的体现上可以将硬件网络当成一类，应用服务当成另一类。